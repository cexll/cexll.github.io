<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>使用Golang的Channel实现PubSub - 小仙的博客</title><meta name="Description" content="使用Golang的Channel实现PubSub"><meta property="og:title" content="使用Golang的Channel实现PubSub" />
<meta property="og:description" content="使用Golang的Channel实现PubSub" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cexll.cn/posts/go-pubsub/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-21T11:15:53+08:00" />
<meta property="article:modified_time" content="2022-07-21T11:15:53+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用Golang的Channel实现PubSub"/>
<meta name="twitter:description" content="使用Golang的Channel实现PubSub"/>
<meta name="application-name" content="小仙的博客">
<meta name="apple-mobile-web-app-title" content="小仙的博客"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://cexll.cn/posts/go-pubsub/" /><link rel="prev" href="https://cexll.cn/posts/%E5%88%A9%E7%94%A8redis%E7%9A%84sub%E5%92%8Cpub%E5%AE%9E%E7%8E%B0im%E9%80%9A%E8%AE%AF/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "使用Golang的Channel实现PubSub",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/cexll.cn\/posts\/go-pubsub\/"
        },"genre": "posts","keywords": "golang, channel, pubsub","wordcount":  1586 ,
        "url": "https:\/\/cexll.cn\/posts\/go-pubsub\/","datePublished": "2022-07-21T11:15:53+08:00","dateModified": "2022-07-21T11:15:53+08:00","publisher": {
            "@type": "Organization",
            "name": "cexll"},"author": {
                "@type": "Person",
                "name": "cexll"
            },"description": "使用Golang的Channel实现PubSub"
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="小仙的博客">小仙的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/about/index.html"> 关于 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="小仙的博客">小仙的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/about/index.html" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">使用Golang的Channel实现PubSub</h1><h2 class="single-subtitle">利用Go管道实现订阅</h2><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="github.com/cexll" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>cexll</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-07-21">2022-07-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1586 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents"></nav></div>
            </div><div class="content" id="content"><h1 id="使用golang的channel实现pubsub">使用Golang的Channel实现PubSub</h1>
<blockquote>
<p>核心的订阅代码借鉴于Docker &ldquo;github.com/docker/docker/pkg/pubsub&rdquo;</p>
</blockquote>
<p>先上代码</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;sync&#34;</span>
	<span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">wgPool</span> <span class="p">=</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Pool</span><span class="p">{</span><span class="nx">New</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span> <span class="p">}}</span>

<span class="c1">// NewPublisher creates a new pub/sub publisher to broadcast messages.
</span><span class="c1">// The duration is used as the send timeout as to not block the publisher publishing
</span><span class="c1">// messages to other clients if one client is slow or unresponsive.
</span><span class="c1">// The buffer is used when creating new channels for subscribers.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewPublisher</span><span class="p">(</span><span class="nx">publishTimeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">buffer</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">Publisher</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Publisher</span><span class="p">{</span>
		<span class="nx">buffer</span><span class="p">:</span>      <span class="nx">buffer</span><span class="p">,</span>
		<span class="nx">timeout</span><span class="p">:</span>     <span class="nx">publishTimeout</span><span class="p">,</span>
		<span class="nx">subscribers</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">subscriber</span><span class="p">]</span><span class="nx">topicFunc</span><span class="p">),</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">subscriber</span> <span class="kd">chan</span> <span class="kd">interface</span><span class="p">{}</span>
<span class="kd">type</span> <span class="nx">topicFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">bool</span>

<span class="c1">// Publisher is basic pub/sub structure. Allows to send events and subscribe
</span><span class="c1">// to them. Can be safely used from multiple goroutines.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Publisher</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">m</span>           <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
	<span class="nx">buffer</span>      <span class="kt">int</span>
	<span class="nx">timeout</span>     <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
	<span class="nx">subscribers</span> <span class="kd">map</span><span class="p">[</span><span class="nx">subscriber</span><span class="p">]</span><span class="nx">topicFunc</span>
<span class="p">}</span>

<span class="c1">// Len returns the number of subscribers for the publisher
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Publisher</span><span class="p">)</span> <span class="nf">Len</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
	<span class="nx">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">)</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
	<span class="k">return</span> <span class="nx">i</span>
<span class="p">}</span>

<span class="c1">// Subscribe adds a new subscriber to the publisher returning the channel.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Publisher</span><span class="p">)</span> <span class="nf">Subscribe</span><span class="p">()</span> <span class="kd">chan</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nf">SubscribeTopic</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// SubscribeTopic adds a new subscriber that filters messages sent by a topic.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Publisher</span><span class="p">)</span> <span class="nf">SubscribeTopic</span><span class="p">(</span><span class="nx">topic</span> <span class="nx">topicFunc</span><span class="p">)</span> <span class="kd">chan</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
	<span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">p</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">[</span><span class="nx">ch</span><span class="p">]</span> <span class="p">=</span> <span class="nx">topic</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="k">return</span> <span class="nx">ch</span>
<span class="p">}</span>

<span class="c1">// SubscribeTopicWithBuffer adds a new subscriber that filters messages sent by a topic.
</span><span class="c1">// The returned channel has a buffer of the specified size.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Publisher</span><span class="p">)</span> <span class="nf">SubscribeTopicWithBuffer</span><span class="p">(</span><span class="nx">topic</span> <span class="nx">topicFunc</span><span class="p">,</span> <span class="nx">buffer</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">chan</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
	<span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">buffer</span><span class="p">)</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">[</span><span class="nx">ch</span><span class="p">]</span> <span class="p">=</span> <span class="nx">topic</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="k">return</span> <span class="nx">ch</span>
<span class="p">}</span>

<span class="c1">// Evict removes the specified subscriber from receiving any more messages.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Publisher</span><span class="p">)</span> <span class="nf">Evict</span><span class="p">(</span><span class="nx">sub</span> <span class="kd">chan</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">[</span><span class="nx">sub</span><span class="p">]</span>
	<span class="k">if</span> <span class="nx">exists</span> <span class="p">{</span>
		<span class="nb">delete</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">,</span> <span class="nx">sub</span><span class="p">)</span>
		<span class="nb">close</span><span class="p">(</span><span class="nx">sub</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Publish sends the data in v to all subscribers currently registered with the publisher.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Publisher</span><span class="p">)</span> <span class="nf">Publish</span><span class="p">(</span><span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">wg</span> <span class="o">:=</span> <span class="nx">wgPool</span><span class="p">.</span><span class="nf">Get</span><span class="p">().(</span><span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">sub</span><span class="p">,</span> <span class="nx">topic</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">subscribers</span> <span class="p">{</span>
		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">go</span> <span class="nx">p</span><span class="p">.</span><span class="nf">sendTopic</span><span class="p">(</span><span class="nx">sub</span><span class="p">,</span> <span class="nx">topic</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">wg</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
	<span class="nx">wgPool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">wg</span><span class="p">)</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Close closes the channels to all subscribers registered with the publisher.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Publisher</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">sub</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">subscribers</span> <span class="p">{</span>
		<span class="nb">delete</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">,</span> <span class="nx">sub</span><span class="p">)</span>
		<span class="nb">close</span><span class="p">(</span><span class="nx">sub</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Publisher</span><span class="p">)</span> <span class="nf">sendTopic</span><span class="p">(</span><span class="nx">sub</span> <span class="nx">subscriber</span><span class="p">,</span> <span class="nx">topic</span> <span class="nx">topicFunc</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">topic</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nf">topic</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="c1">// send under a select as to not block if the receiver is unavailable
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">timeout</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">timeout</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">timeout</span><span class="p">)</span>
		<span class="k">defer</span> <span class="nx">timeout</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>

		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">sub</span> <span class="o">&lt;-</span> <span class="nx">v</span><span class="p">:</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">timeout</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
		<span class="p">}</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="k">select</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">sub</span> <span class="o">&lt;-</span> <span class="nx">v</span><span class="p">:</span>
	<span class="k">default</span><span class="p">:</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Server代码</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;sync&#34;</span>
	<span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Server</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Bucket</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Publisher</span>
	<span class="nx">m</span>      <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewServer</span><span class="p">()</span> <span class="o">*</span><span class="nx">Server</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span>
		<span class="nx">Bucket</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Publisher</span><span class="p">),</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 订阅主题
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Sub</span><span class="p">(</span><span class="nx">subName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">newPublisher</span><span class="p">(</span><span class="nx">subName</span><span class="p">)</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">SubscribeTopic</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="c1">// 判断是不是字符串
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.(</span><span class="kt">string</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">true</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">})</span>
  <span class="c1">// 为了实现阻塞 需要先发送一个ping来激活
</span><span class="c1"></span>	<span class="nx">p</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="s">&#34;ping&#34;</span><span class="p">)</span>
	<span class="k">select</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">:</span>
		<span class="k">for</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span> <span class="p">{</span>
      <span class="c1">// 推送的内容
</span><span class="c1"></span>			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>
<span class="c1">// 推送内容
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Pub</span><span class="p">(</span><span class="nx">subName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">newPublisher</span><span class="p">(</span><span class="nx">subName</span><span class="p">)</span>
	<span class="nx">p</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// 关闭订阅
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Close</span><span class="p">(</span><span class="nx">subName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">newPublisher</span><span class="p">(</span><span class="nx">subName</span><span class="p">)</span>

	<span class="nx">p</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">//  关闭订阅
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">UnSub</span><span class="p">(</span><span class="nx">subName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO 关闭订阅
</span><span class="c1"></span>  <span class="c1">// 这里可以自己实现相关关闭订阅的业务代码
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// 获取一个Publisher
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">newPublisher</span><span class="p">(</span><span class="nx">subName</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Publisher</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Bucket</span><span class="p">[</span><span class="nx">subName</span><span class="p">]</span>
	<span class="k">if</span> <span class="nx">p</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">p</span> <span class="p">=</span> <span class="nf">NewPublisher</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">Bucket</span><span class="p">[</span><span class="nx">subName</span><span class="p">]</span> <span class="p">=</span> <span class="nx">p</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">p</span>
<span class="p">}</span>
</code></pre></div><p><code>Main.go</code></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 获取订阅服务
</span><span class="c1"></span>    <span class="nx">s</span> <span class="o">:=</span> <span class="nf">NewServer</span><span class="p">()</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;server running...&#34;</span><span class="p">)</span>
  <span class="c1">// 订阅hello
</span><span class="c1"></span>	<span class="k">go</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">)</span>
  <span class="c1">// 等待订阅完成
</span><span class="c1"></span>	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

	<span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">i</span><span class="o">++</span>
    <span class="c1">// 循环向hello发送
</span><span class="c1"></span>		<span class="nx">s</span><span class="p">.</span><span class="nf">Pub</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;啊哈哈哈 golang channel %d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span>
		<span class="k">if</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="mi">100</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
	<span class="p">}</span>
  <span class="c1">// 等待订阅消费完
</span><span class="c1"></span>  <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
  <span class="c1">// 关闭队列
</span><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>测试结果</p>
<pre><code>server running...
啊哈哈哈 golang channel 1
啊哈哈哈 golang channel 2
啊哈哈哈 golang channel 3
啊哈哈哈 golang channel 4
啊哈哈哈 golang channel 5
啊哈哈哈 golang channel 6
啊哈哈哈 golang channel 7
啊哈哈哈 golang channel 8
啊哈哈哈 golang channel 9
啊哈哈哈 golang channel 10
啊哈哈哈 golang channel 11
啊哈哈哈 golang channel 12
啊哈哈哈 golang channel 13
啊哈哈哈 golang channel 14
啊哈哈哈 golang channel 15
啊哈哈哈 golang channel 16
啊哈哈哈 golang channel 17
啊哈哈哈 golang channel 18
啊哈哈哈 golang channel 19
啊哈哈哈 golang channel 20
啊哈哈哈 golang channel 21
啊哈哈哈 golang channel 22
啊哈哈哈 golang channel 23
啊哈哈哈 golang channel 24
啊哈哈哈 golang channel 25
啊哈哈哈 golang channel 26
啊哈哈哈 golang channel 27
啊哈哈哈 golang channel 28
啊哈哈哈 golang channel 29
啊哈哈哈 golang channel 30
啊哈哈哈 golang channel 31
啊哈哈哈 golang channel 32
啊哈哈哈 golang channel 33
啊哈哈哈 golang channel 34
啊哈哈哈 golang channel 35
啊哈哈哈 golang channel 36
啊哈哈哈 golang channel 37
啊哈哈哈 golang channel 38
啊哈哈哈 golang channel 39
啊哈哈哈 golang channel 40
啊哈哈哈 golang channel 41
啊哈哈哈 golang channel 42
啊哈哈哈 golang channel 43
啊哈哈哈 golang channel 44
啊哈哈哈 golang channel 45
啊哈哈哈 golang channel 46
啊哈哈哈 golang channel 47
啊哈哈哈 golang channel 48
啊哈哈哈 golang channel 49
啊哈哈哈 golang channel 50
啊哈哈哈 golang channel 51
啊哈哈哈 golang channel 52
啊哈哈哈 golang channel 53
啊哈哈哈 golang channel 54
啊哈哈哈 golang channel 55
啊哈哈哈 golang channel 56
啊哈哈哈 golang channel 57
啊哈哈哈 golang channel 58
啊哈哈哈 golang channel 59
啊哈哈哈 golang channel 60
啊哈哈哈 golang channel 61
啊哈哈哈 golang channel 62
啊哈哈哈 golang channel 63
啊哈哈哈 golang channel 64
啊哈哈哈 golang channel 65
啊哈哈哈 golang channel 66
啊哈哈哈 golang channel 67
啊哈哈哈 golang channel 68
啊哈哈哈 golang channel 69
啊哈哈哈 golang channel 70
啊哈哈哈 golang channel 71
啊哈哈哈 golang channel 72
啊哈哈哈 golang channel 73
啊哈哈哈 golang channel 74
啊哈哈哈 golang channel 75
啊哈哈哈 golang channel 76
啊哈哈哈 golang channel 77
啊哈哈哈 golang channel 78
啊哈哈哈 golang channel 79
啊哈哈哈 golang channel 80
啊哈哈哈 golang channel 81
啊哈哈哈 golang channel 82
啊哈哈哈 golang channel 83
啊哈哈哈 golang channel 84
啊哈哈哈 golang channel 85
啊哈哈哈 golang channel 86
啊哈哈哈 golang channel 87
啊哈哈哈 golang channel 88
啊哈哈哈 golang channel 89
啊哈哈哈 golang channel 90
啊哈哈哈 golang channel 91
啊哈哈哈 golang channel 92
啊哈哈哈 golang channel 93
啊哈哈哈 golang channel 94
啊哈哈哈 golang channel 95
啊哈哈哈 golang channel 96
啊哈哈哈 golang channel 97
啊哈哈哈 golang channel 98
啊哈哈哈 golang channel 99
啊哈哈哈 golang channel 100
啊哈哈哈 golang channel 101
</code></pre><h1 id="核心原理">核心原理</h1>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 订阅
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">subscriber</span> <span class="kd">chan</span> <span class="kd">interface</span><span class="p">{}</span>
<span class="c1">// 主题方法
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">topicFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">v</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">bool</span>

<span class="kd">type</span> <span class="nx">Publisher</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">m</span>           <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>          <span class="c1">// 读写锁
</span><span class="c1"></span>	<span class="nx">buffer</span>      <span class="kt">int</span>                   <span class="c1">// 缓冲区
</span><span class="c1"></span>	<span class="nx">timeout</span>     <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>         <span class="c1">// 超时时间
</span><span class="c1"></span>	<span class="nx">subscribers</span> <span class="kd">map</span><span class="p">[</span><span class="nx">subscriber</span><span class="p">]</span><span class="nx">topicFunc</span>  <span class="c1">// 主题
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>Github地址</p>
<blockquote>
<p><a href="https://github.com/go-ll/pubsub">https://github.com/go-ll/pubsub</a></p>
</blockquote></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-07-21</span>
            </div>
            <div class="post-info-license"><span>MIT</span></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/golang/">golang</a>,&nbsp;<a href="/tags/channel/">channel</a>,&nbsp;<a href="/tags/pubsub/">pubsub</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E5%88%A9%E7%94%A8redis%E7%9A%84sub%E5%92%8Cpub%E5%AE%9E%E7%8E%B0im%E9%80%9A%E8%AE%AF/" class="prev" rel="prev" title="利用Redis的Sub和Pub实现Im通讯"><i class="fas fa-angle-left fa-fw"></i>利用Redis的Sub和Pub实现Im通讯</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.85.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
